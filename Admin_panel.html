<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Console - GPTC Pala</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link rel="icon" type="image/png" href="assets/logo.png">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; scroll-behavior: smooth; }
        .touch-target { min-height: 48px; }
        .tab-active { background-color: #4f46e5; color: white !important; font-weight: 600; border-radius: 0.5rem; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .attendance-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 0.75rem; }
        .roll-btn { aspect-ratio: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 0.75rem; border: 2px solid #e2e8f0; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .roll-btn.present { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }
        .roll-btn.absent { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; opacity: 0.8; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; z-index: 50; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal.hidden { display: none; }
        .lumina-power-footer { display: flex; justify-content: center; align-items: center; gap: 0.5rem; font-family: 'Poppins', sans-serif; text-decoration: none; margin-top: 0.75rem; opacity: 0.7; transition: opacity 0.3s ease; }
        .lumina-power-footer:hover { opacity: 1; }
        .lumina-power-text { font-size: 0.75rem; font-weight: 400; color: #9ca3af; }
        .lumina-logo-text { font-size: 1rem; font-weight: 700; color: #e0e0e0; letter-spacing: 0.05em; }
        .lumina-logo-text .accent { color: #007BFF; }
        .lumina-logo-tagline { font-size: 0.5rem; font-weight: 400; color: #9ca3af; letter-spacing: 0.2em; text-transform: uppercase; }
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-800">

    <!-- LOGIN SCREEN -->
    <div id="loginPage" class="min-h-screen flex flex-col items-center justify-center bg-slate-900 p-4 relative overflow-hidden">
        <div class="bg-white/95 backdrop-blur-xl p-8 md:p-10 rounded-3xl shadow-2xl w-full max-w-md text-center border border-white/10 z-10">
            <div class="flex justify-center mb-6">
                <img src="https://cdn.universitykart.com//Content/upload/admin/2gxbml1q.ori.jpg" alt="GPC Pala Logo" class="w-24 h-24 rounded-full shadow-lg border-4 border-indigo-100">
            </div>
            <h1 class="text-2xl font-extrabold text-slate-900">Attendance Admin</h1>
            <p class="text-slate-500 text-sm mb-8">Dept. of EEE • GPTC Pala</p>
            <form id="loginForm" class="space-y-5 text-left">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">Admin Email</label>
                    <input type="email" id="email" value="admin@gptcpala.com" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase ml-1">Password</label>
                    <input type="password" id="password" required class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div class="pt-2 gap-3 flex flex-col">
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-lg transition transform active:scale-95">Login to Console</button>
                    <button type="button" id="btnRegister" class="text-sm text-indigo-600 font-semibold hover:underline">Create New Admin Account</button>
                </div>
                <div id="loginMessage" class="text-xs text-center font-medium min-h-[20px] mt-2"></div>
            </form>
        </div>
        <div class="mt-8 text-center z-10">
            <a href="https://luminaweb.vercel.app/" target="_blank" rel="noopener noreferrer" class="lumina-power-footer" title="Powered by Lumina Web Solutions">
                <span class="lumina-power-text">Powered by</span>
                <div class="lumina-logo-container"><div class="lumina-logo-text"><span>LUMINA</span><span class="accent">.</span></div><div class="lumina-logo-tagline">WEB SOLUTIONS</div></div>
            </a>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="hidden flex-1 flex flex-col bg-slate-50">
        <header class="bg-slate-900 text-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <img src="https://cdn.universitykart.com//Content/upload/admin/2gxbml1q.ori.jpg" class="w-10 h-10 rounded-full border-2 border-white/20">
                    <div class="leading-tight"><h1 class="font-bold text-lg">Admin Console</h1><p class="text-[10px] text-slate-400 uppercase tracking-wider">GPTC Pala EEE</p></div>
                </div>
                <div class="flex items-center gap-2">
                     <select id="semesterSelect" class="bg-slate-800 text-white border border-slate-700 text-sm rounded-lg focus:ring-indigo-500 block p-2">
                        <option value="1">Sem 1</option><option value="2">Sem 2</option><option value="3">Sem 3</option><option value="4">Sem 4</option><option value="5">Sem 5</option><option value="6">Sem 6</option>
                    </select>
                    <button id="logoutButton" class="bg-red-500/20 text-red-400 p-2 rounded-lg hover:bg-red-500/30"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>
        </header>

        <nav class="bg-white shadow-sm border-b border-slate-200 sticky top-[64px] z-30">
            <div class="container mx-auto overflow-x-auto no-scrollbar">
                <div class="flex p-2 gap-2 min-w-max">
                    <button class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 transition rounded-lg tab-active tab-button" data-tab="dashboard"><i class="fa-solid fa-chart-pie mr-1"></i> Dashboard</button>
                    <button class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 transition rounded-lg tab-button" data-tab="attendance"><i class="fa-solid fa-clipboard-check mr-1"></i> Mark Attendance</button>
                    <button class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 transition rounded-lg tab-button" data-tab="students"><i class="fa-solid fa-users mr-1"></i> Students</button>
                    <button class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 transition rounded-lg tab-button" data-tab="faculty"><i class="fa-solid fa-chalkboard-user mr-1"></i> Faculty & Roles</button>
                    <button class="px-4 py-2 text-sm text-slate-600 hover:bg-slate-50 transition rounded-lg tab-button" data-tab="reports"><i class="fa-solid fa-file-pdf mr-1"></i> Reports</button>
                </div>
            </div>
        </nav>

        <main class="flex-1 container mx-auto p-4 pb-24 max-w-5xl">
            <section id="dashboard" class="tab-content active">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Overview (Semester <span id="dashSemester"></span>)</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><p class="text-xs text-slate-500 uppercase font-bold">Students</p><h3 class="text-2xl font-bold text-indigo-600" id="statStudentCount">0</h3></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><p class="text-xs text-slate-500 uppercase font-bold">Faculty</p><h3 class="text-2xl font-bold text-emerald-600" id="statFacultyCount">0</h3></div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100"><p class="text-xs text-slate-500 uppercase font-bold">Subjects</p><h3 class="text-2xl font-bold text-purple-600" id="statSubjectCount">0</h3></div>
                </div>
                <div class="bg-indigo-50 p-6 rounded-2xl border border-indigo-100 mb-6">
                    <h3 class="font-bold text-indigo-900 mb-2">Admin Quick Actions</h3>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="showTab('students')" class="bg-white text-indigo-700 px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-indigo-50">Add Students</button>
                        <button onclick="showTab('attendance')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-indigo-700">Take Attendance</button>
                        <button onclick="generateMissingCredentials()" class="bg-amber-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-amber-600"><i class="fa-solid fa-key mr-1"></i> Fix Missing Creds</button>
                    </div>
                </div>
            </section>

            <section id="attendance" class="tab-content">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Mark Attendance</h2>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
                        <input type="date" id="attDate" class="w-full p-2 border rounded-lg text-sm">
                        <select id="attPeriod" class="w-full p-2 border rounded-lg text-sm"><option value="">Select Period</option><option value="1">Period 1</option><option value="2">Period 2</option><option value="3">Period 3</option><option value="4">Period 4</option><option value="5">Period 5</option><option value="6">Period 6</option></select>
                        <select id="attFaculty" class="w-full p-2 border rounded-lg text-sm"><option>Loading...</option></select>
                        <select id="attSubject" class="w-full p-2 border rounded-lg text-sm"><option>Loading...</option></select>
                    </div>
                    <div class="mb-4">
                        <p class="text-sm font-bold text-slate-700 mb-2">Tap Roll Numbers to Mark <span class="text-green-600">Present</span>:</p>
                        <div id="attendanceGrid" class="attendance-grid min-h-[100px] bg-slate-50 p-4 rounded-xl border border-slate-100"><p class="col-span-full text-center text-slate-400 text-sm py-4">Select a date and period, then students will appear here.</p></div>
                    </div>
                    <div class="flex justify-between items-center pt-2 border-t">
                        <div class="text-sm"><span class="font-bold text-green-600" id="countPresent">0 Present</span> • <span class="font-bold text-red-500" id="countAbsent">0 Absent</span></div>
                        <button id="saveAttendanceBtn" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition">Submit Log</button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b flex justify-between items-center"><h3 class="font-bold text-slate-700 text-sm">Recent Logs</h3><button onclick="downloadPDF('today')" class="text-xs bg-white border hover:bg-slate-50 px-3 py-1.5 rounded-lg text-slate-600 font-medium"><i class="fa-solid fa-file-pdf text-red-500 mr-1"></i> PDF</button></div>
                    <div id="todaysLogsList" class="divide-y divide-slate-100"></div>
                </div>
            </section>

            <section id="students" class="tab-content">
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-slate-800">Students</h2><button onclick="openModal('addStudentModal')" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm"><i class="fa-solid fa-user-plus mr-1"></i> Add</button></div>
                <div class="mb-4"><input type="text" id="studentSearch" placeholder="Search Roll No or Name..." class="w-full px-4 py-3 rounded-xl border border-slate-200 shadow-sm text-sm"></div>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-4"><div class="overflow-x-auto"><table class="min-w-full text-sm text-left"><thead class="bg-slate-50 text-slate-500 uppercase font-bold text-xs"><tr><th class="px-4 py-3">Roll No</th><th class="px-4 py-3">Name</th><th class="px-4 py-3">System Email / Pass</th><th class="px-4 py-3 text-right">Actions</th></tr></thead><tbody id="studentTableBody" class="divide-y divide-slate-100"></tbody></table></div></div>
                <div class="flex gap-2"><button onclick="openPromotionModal()" class="flex-1 bg-indigo-100 text-indigo-700 py-3 rounded-xl font-bold text-sm hover:bg-indigo-200">Promote Students</button><button onclick="downloadPDF('students')" class="flex-1 bg-slate-200 text-slate-700 py-3 rounded-xl font-bold text-sm hover:bg-slate-300">Download List (PDF)</button></div>
            </section>
            
            <section id="faculty" class="tab-content">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">Faculty & Roles</h2>
                        <p class="text-xs text-slate-500">All faculty are listed here. Assign Tutors based on selected Semester.</p>
                    </div>
                    <button onclick="openModal('addFacultyModal')" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm"><i class="fa-solid fa-plus mr-1"></i> Add</button>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg mb-4 text-sm flex items-center gap-2">
                    <i class="fa-solid fa-info-circle text-yellow-600"></i>
                    <span class="text-yellow-800">Currently configuring Tutors for <strong>Semester <span id="facSemDisplay"></span></strong>. Switch semester at top to manage other classes.</span>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 uppercase font-bold text-xs">
                            <tr>
                                <th class="px-4 py-3">Name</th>
                                <th class="px-4 py-3">Role Badges</th>
                                <th class="px-4 py-3">Credentials</th>
                                <th class="px-4 py-3 text-right">Assign Roles</th>
                            </tr>
                        </thead>
                        <tbody id="facultyTableBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>

                <div class="mt-8">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-slate-800">Subjects (Sem <span id="subSemDisplay"></span>)</h2>
                        <button onclick="openModal('addSubjectModal')" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm">Add Subject</button>
                    </div>
                    <div id="subjectListContainer" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                </div>
            </section>

            <section id="reports" class="tab-content">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Monthly Reports</h2>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Select Month</label>
                    <div class="flex gap-2 mb-4"><input type="month" id="reportMonth" class="w-full px-4 py-2 border rounded-lg text-sm"><button id="generateReportBtn" class="bg-indigo-600 text-white px-6 rounded-lg font-bold text-sm">View</button></div>
                    <div id="reportResults" class="hidden">
                        <div class="flex justify-end gap-2 mb-3"><button onclick="downloadPDF('monthly')" class="text-xs bg-red-50 text-red-600 border border-red-100 hover:bg-red-100 px-4 py-2 rounded-lg font-bold"><i class="fa-solid fa-file-pdf mr-1"></i> Download PDF</button><button onclick="downloadCSVReport()" class="text-xs bg-green-50 text-green-600 border border-green-100 hover:bg-green-100 px-4 py-2 rounded-lg font-bold"><i class="fa-solid fa-file-csv mr-1"></i> CSV</button></div>
                        <div class="overflow-x-auto border rounded-lg"><table class="min-w-full text-sm text-left" id="monthlyReportTable"><thead class="bg-slate-50 text-slate-500 uppercase font-bold text-xs"><tr><th class="px-4 py-2">Roll No</th><th class="px-4 py-2">Name</th><th class="px-4 py-2 text-center">Total</th><th class="px-4 py-2 text-center">Attended</th><th class="px-4 py-2 text-right">%</th></tr></thead><tbody id="monthlyReportBody" class="divide-y divide-slate-100 bg-white"></tbody></table></div>
                    </div>
                </div>
            </section>
        </main>
        <footer class="bg-slate-900 text-slate-400 py-8 text-center text-sm mt-auto"><div class="container mx-auto px-4"><p class="font-bold text-white mb-1">Dept. of EEE, GPTC Pala</p><a href="https://luminaweb.vercel.app/" target="_blank" class="lumina-power-footer"><span class="lumina-power-text">Powered by</span><div class="lumina-logo-container"><div class="lumina-logo-text"><span>LUMINA</span><span class="accent">.</span></div><div class="lumina-logo-tagline">WEB SOLUTIONS</div></div></a><p class="text-[10px] mt-2 opacity-50">Administrative Console v2.1</p></div></footer>
    </div>

    <div id="addStudentModal" class="modal hidden"><div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4"><h3 class="text-lg font-bold mb-4">Register New Student</h3><form id="addStudentForm" class="space-y-3"><input type="text" id="newRollNo" placeholder="Roll Number (e.g. 22EEE01)" required class="w-full p-2 border rounded-lg text-sm"><input type="text" id="newStudentName" placeholder="Full Name" required class="w-full p-2 border rounded-lg text-sm"><p class="text-xs text-slate-500 bg-slate-50 p-2 rounded">System will auto-generate login credentials.</p><div class="flex gap-2 pt-2"><button type="button" onclick="closeModal('addStudentModal')" class="flex-1 py-2 bg-slate-100 rounded-lg text-sm font-bold">Cancel</button><button type="submit" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold">Register</button></div></form></div></div>
    <div id="promotionModal" class="modal hidden"><div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md mx-4 flex flex-col max-h-[80vh]"><h3 class="text-lg font-bold mb-2">Selective Promotion</h3><p class="text-xs text-slate-500 mb-4">Tick students to move from Sem <span id="promoCurrentSem"></span> to:</p><select id="promoTargetSem" class="w-full p-2 border rounded-lg text-sm mb-4 bg-slate-50 font-bold"><option value="">Select Target Semester</option><option value="2">Semester 2</option><option value="3">Semester 3</option><option value="4">Semester 4</option><option value="5">Semester 5</option><option value="6">Semester 6</option><option value="passout">Passout</option></select><div class="flex-1 overflow-y-auto border rounded-lg p-2 mb-4 bg-slate-50 space-y-1" id="promoStudentList"></div><div class="flex gap-2"><button onclick="closeModal('promotionModal')" class="flex-1 py-2 bg-slate-100 rounded-lg text-sm font-bold">Cancel</button><button onclick="executePromotion()" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg text-sm font-bold">Promote Selected</button></div></div></div>
    <div id="addFacultyModal" class="modal hidden"><div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4"><h3 class="text-lg font-bold mb-4">Add Faculty</h3><form id="addFacultyForm" class="space-y-3"><input type="text" id="newFacultyName" placeholder="Faculty Name" required class="w-full p-2 border rounded-lg text-sm"><div class="flex gap-2 pt-2"><button type="submit" class="w-full bg-emerald-500 text-white py-2 rounded-lg font-bold">Save</button><button type="button" onclick="closeModal('addFacultyModal')" class="w-full bg-gray-200 py-2 rounded-lg font-bold">Cancel</button></div></form></div></div>
    <div id="addSubjectModal" class="modal hidden"><div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4"><h3 class="text-lg font-bold mb-4">Add Subject</h3><form id="addSubjectForm" class="space-y-3"><input type="text" id="newSubjectName" placeholder="Subject Name" required class="w-full p-2 border rounded-lg text-sm"><div class="flex gap-2 pt-2"><button type="submit" class="w-full bg-purple-500 text-white py-2 rounded-lg font-bold">Save</button><button type="button" onclick="closeModal('addSubjectModal')" class="w-full bg-gray-200 py-2 rounded-lg font-bold">Cancel</button></div></form></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, where, doc, updateDoc, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAnf5rSx0FLGEhooppoXnnl74rrIR-Z1lM", authDomain: "attendance-eee.firebaseapp.com", projectId: "attendance-eee", storageBucket: "attendance-eee.firebasestorage.app", messagingSenderId: "843713468526", appId: "1:843713468526:web:3b2ef56f8a964336e0ee7f" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app); const appId = 'attendance-eee-app-global-share';
        let currentSemester = localStorage.getItem('currentSemester') || '1';
        let studentsData = [], facultyData = [], subjectsData = [];

        onAuthStateChanged(auth, user => {
            if(user) { document.getElementById('loginPage').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden'); initApp(); } 
            else { document.getElementById('loginPage').classList.remove('hidden'); document.getElementById('mainApp').classList.add('hidden'); }
        });

        function initApp() { 
            document.getElementById('semesterSelect').value = currentSemester; 
            document.getElementById('dashSemester').textContent = currentSemester; 
            document.getElementById('facSemDisplay').textContent = currentSemester;
            document.getElementById('subSemDisplay').textContent = currentSemester;
            setupRealtimeListeners(); 
        }
        document.getElementById('semesterSelect').addEventListener('change', e => { currentSemester = e.target.value; localStorage.setItem('currentSemester', currentSemester); initApp(); });

        function setupRealtimeListeners() {
            const base = `artifacts/${appId}/public/data`;
            onSnapshot(query(collection(db, `${base}/students`), where("semester", "==", currentSemester)), snap => { studentsData = []; snap.forEach(d => studentsData.push({id: d.id, ...d.data()})); studentsData.sort((a,b) => a.rollNo.localeCompare(b.rollNo)); renderStudents(); renderDashboard(); renderAttendanceGrid(); });
            // MODIFIED: Fetch ALL faculty, not semester specific
            onSnapshot(collection(db, `${base}/faculty`), snap => { facultyData = []; snap.forEach(d => facultyData.push({id: d.id, ...d.data()})); renderFaculty(); renderDashboard(); populateDropdowns(); });
            onSnapshot(query(collection(db, `${base}/subjects`), where("semester", "==", currentSemester)), snap => { subjectsData = []; snap.forEach(d => subjectsData.push({id: d.id, ...d.data()})); renderSubjects(); renderDashboard(); populateDropdowns(); });
        }

        function renderStudents() {
            const tbody = document.getElementById('studentTableBody'); const search = document.getElementById('studentSearch').value.toLowerCase(); tbody.innerHTML = '';
            studentsData.filter(s => s.name.toLowerCase().includes(search) || s.rollNo.toLowerCase().includes(search)).forEach(s => {
                // NEW: Add rep badge
                const repBadge = s.isRep ? '<span class="bg-amber-100 text-amber-800 text-[10px] px-1.5 py-0.5 rounded border border-amber-200 ml-2">Rep</span>' : '';
                tbody.innerHTML += `<tr class="hover:bg-slate-50 group"><td class="px-4 py-3 font-bold text-slate-700">${s.rollNo}</td><td class="px-4 py-3 flex items-center">${s.name}${repBadge}</td><td class="px-4 py-3 text-xs font-mono text-slate-500">${s.generatedEmail || 'N/A'}<br>Pass: ${s.generatedPassword || 'N/A'}</td><td class="px-4 py-3 text-right"><button onclick="deleteItem('students', '${s.id}')" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
            document.getElementById('statStudentCount').textContent = studentsData.length;
        }

        function renderFaculty() {
            const tbody = document.getElementById('facultyTableBody'); 
            tbody.innerHTML = '';
            
            facultyData.forEach(f => { 
                const isHOD = f.isHOD ? '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-bold border border-yellow-300 mr-1">HOD</span>' : '';
                const isTutor = (f.tutorSemesters || []).includes(currentSemester) ? `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold border border-blue-300">Tutor Sem ${currentSemester}</span>` : '';
                const tutorBtnClass = (f.tutorSemesters || []).includes(currentSemester) ? 'bg-blue-600 text-white' : 'bg-white border border-slate-300 text-slate-600';
                
                tbody.innerHTML += `
                <tr class="hover:bg-slate-50 group">
                    <td class="px-4 py-3 font-bold text-slate-700">${f.name}</td>
                    <td class="px-4 py-3">${isHOD}${isTutor}</td>
                    <td class="px-4 py-3 text-xs font-mono text-slate-500">${f.generatedEmail || 'N/A'}<br>Pass: ${f.generatedPassword || 'N/A'}</td>
                    <td class="px-4 py-3 text-right space-x-2">
                        <button onclick="toggleHOD('${f.id}')" class="text-xs px-2 py-1 rounded border border-yellow-400 hover:bg-yellow-50 text-yellow-700" title="Make HOD"><i class="fa-solid fa-crown"></i></button>
                        <button onclick="toggleTutor('${f.id}')" class="text-xs px-2 py-1 rounded hover:shadow-sm ${tutorBtnClass}" title="Toggle Tutor"><i class="fa-solid fa-chalkboard-user"></i> Tutor</button>
                        <button onclick="deleteItem('faculty', '${f.id}')" class="text-red-400 hover:text-red-600 ml-2"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`; 
            });
            document.getElementById('statFacultyCount').textContent = facultyData.length;
        }

        function renderSubjects() {
            const container = document.getElementById('subjectListContainer'); container.innerHTML = '';
            subjectsData.forEach(s => { container.innerHTML += `<div class="bg-white border p-3 rounded-lg text-center text-xs font-bold text-slate-600 shadow-sm relative group">${s.name}<button onclick="deleteItem('subjects', '${s.id}')" class="absolute top-1 right-1 text-red-400 hidden group-hover:block"><i class="fa-solid fa-times"></i></button></div>`; });
            document.getElementById('statSubjectCount').textContent = subjectsData.length;
        }
        function renderDashboard() {}

        let presentRolls = new Set();
        function renderAttendanceGrid() {
            const grid = document.getElementById('attendanceGrid'); if(!studentsData.length) { grid.innerHTML = `<p class="col-span-full text-center text-red-400 text-sm py-4">No students in this semester.</p>`; return; }
            grid.innerHTML = ''; presentRolls.clear();
            studentsData.forEach(s => {
                const btn = document.createElement('div'); btn.className = 'roll-btn absent touch-target'; btn.innerHTML = `<span class="text-lg">${s.rollNo.slice(-2)}</span><span class="text-[10px] truncate w-full text-center px-1">${s.name.split(' ')[0]}</span>`; btn.dataset.roll = s.rollNo;
                btn.onclick = () => { if(presentRolls.has(s.rollNo)) { presentRolls.delete(s.rollNo); btn.classList.remove('present'); btn.classList.add('absent'); } else { presentRolls.add(s.rollNo); btn.classList.remove('absent'); btn.classList.add('present'); } updateCounts(); };
                grid.appendChild(btn);
            }); updateCounts();
        }
        function updateCounts() { document.getElementById('countPresent').textContent = `${presentRolls.size} Present`; document.getElementById('countAbsent').textContent = `${studentsData.length - presentRolls.size} Absent`; }

        function generateCredentials(name, type) { const cleanName = name.toLowerCase().replace(/\s+/g, '').substring(0, 5); const rand = Math.floor(1000 + Math.random() * 9000); return { email: `${cleanName}${rand}@gptcpala.in`, password: `Pass@${rand}` }; }

        document.getElementById('addStudentForm').addEventListener('submit', async e => {
            e.preventDefault(); const name = document.getElementById('newStudentName').value; const roll = document.getElementById('newRollNo').value.toUpperCase(); const creds = generateCredentials(name, 'student');
            await addDoc(collection(db, `artifacts/${appId}/public/data/students`), { name, rollNo: roll, semester: currentSemester, generatedEmail: creds.email, generatedPassword: creds.password, role: 'student' }); closeModal('addStudentModal'); e.target.reset();
        });
        
        // MODIFIED: Add faculty globally (no semester)
        document.getElementById('addFacultyForm').addEventListener('submit', async e => {
            e.preventDefault(); const name = document.getElementById('newFacultyName').value; const creds = generateCredentials(name, 'faculty');
            await addDoc(collection(db, `artifacts/${appId}/public/data/faculty`), { name, generatedEmail: creds.email, generatedPassword: creds.password, role: 'faculty', isHOD: false, tutorSemesters: [] }); closeModal('addFacultyModal'); e.target.reset();
        });
        document.getElementById('addSubjectForm').addEventListener('submit', async e => { e.preventDefault(); await addDoc(collection(db, `artifacts/${appId}/public/data/subjects`), { name: document.getElementById('newSubjectName').value, semester: currentSemester }); closeModal('addSubjectModal'); e.target.reset(); });

        document.getElementById('saveAttendanceBtn').addEventListener('click', async () => {
            const date = document.getElementById('attDate').value; const period = document.getElementById('attPeriod').value; const faculty = document.getElementById('attFaculty').value; const subject = document.getElementById('attSubject').value;
            if(!date || !period || !faculty || !subject) return alert("Fill all fields");
            const absentRollNos = studentsData.filter(s => !presentRolls.has(s.rollNo)).map(s => s.rollNo);
            await addDoc(collection(db, `artifacts/${appId}/public/data/dailyAttendance`), { date, periodNo: parseInt(period), facultyName: faculty, subjectName: subject, absentRollNos, semester: currentSemester, timestamp: new Date().toISOString() });
            alert("Attendance Logged Successfully!"); presentRolls.clear(); renderAttendanceGrid(); fetchTodaysLogs();
        });

        // NEW ROLE MANAGEMENT FUNCTIONS
        window.toggleHOD = async (id) => {
            if(!confirm("Set this faculty as the new HOD? This will remove HOD status from anyone else.")) return;
            // 1. Remove HOD from all others
            const batchPromises = [];
            facultyData.forEach(f => {
                if(f.isHOD) batchPromises.push(updateDoc(doc(db, `artifacts/${appId}/public/data/faculty/${f.id}`), { isHOD: false }));
            });
            await Promise.all(batchPromises);
            // 2. Set new HOD
            await updateDoc(doc(db, `artifacts/${appId}/public/data/faculty/${id}`), { isHOD: true });
        };

        window.toggleTutor = async (id) => {
            const fac = facultyData.find(f => f.id === id);
            let tutors = fac.tutorSemesters || [];
            if (tutors.includes(currentSemester)) {
                tutors = tutors.filter(s => s !== currentSemester);
            } else {
                tutors.push(currentSemester);
            }
            await updateDoc(doc(db, `artifacts/${appId}/public/data/faculty/${id}`), { tutorSemesters: tutors });
        };

        window.downloadPDF = (type) => {
            const { jsPDF } = window.jspdf; const doc = new jsPDF(); const title = `GPTC Pala - EEE Dept (${currentSemester})`; doc.setFontSize(16); doc.text(title, 14, 15); doc.setFontSize(10);
            if (type === 'students') { doc.text(`Student List`, 14, 22); const tableData = studentsData.map(s => [s.rollNo, s.name, s.generatedEmail, s.generatedPassword]); doc.autoTable({ head: [['Roll No', 'Name', 'Login Email', 'Login Password']], body: tableData, startY: 25 }); doc.save(`students_${currentSemester}.pdf`); } 
            else if (type === 'monthly') { doc.autoTable({ html: '#monthlyReportTable', startY: 25 }); doc.save(`attendance_report_${currentSemester}.pdf`); }
            else if (type === 'today') { doc.text(`Daily Logs`, 14, 22); alert("Please generate the specific report first."); }
        };

        window.generateMissingCredentials = async () => {
            if(!confirm("Generate credentials for missing users?")) return; let count = 0; const updates = [];
            studentsData.forEach(s => { if(!s.generatedEmail) { const creds = generateCredentials(s.name, 'student'); updates.push(updateDoc(doc(db, `artifacts/${appId}/public/data/students/${s.id}`), { generatedEmail: creds.email, generatedPassword: creds.password, role: 'student' })); count++; } });
            facultyData.forEach(f => { if(!f.generatedEmail) { const creds = generateCredentials(f.name, 'faculty'); updates.push(updateDoc(doc(db, `artifacts/${appId}/public/data/faculty/${f.id}`), { generatedEmail: creds.email, generatedPassword: creds.password, role: 'faculty' })); count++; } });
            await Promise.all(updates); alert(`Generated for ${count} users.`);
        };

        window.openPromotionModal = () => {
            const list = document.getElementById('promoStudentList'); document.getElementById('promoCurrentSem').textContent = currentSemester; list.innerHTML = '';
            studentsData.forEach(s => { list.innerHTML += `<label class="flex items-center space-x-3 p-2 bg-white rounded border hover:bg-indigo-50 cursor-pointer"><input type="checkbox" class="promo-check w-5 h-5 text-indigo-600 rounded" value="${s.id}"><span class="font-mono font-bold text-slate-600 w-20">${s.rollNo}</span><span class="text-sm">${s.name}</span></label>`; });
            document.getElementById('promotionModal').classList.remove('hidden');
        }
        window.executePromotion = async () => {
            const target = document.getElementById('promoTargetSem').value; if(!target) return alert("Select target semester");
            const checks = document.querySelectorAll('.promo-check:checked'); if(checks.length === 0) return alert("No students selected");
            const promises = Array.from(checks).map(c => updateDoc(doc(db, `artifacts/${appId}/public/data/students/${c.value}`), { semester: target }));
            await Promise.all(promises); alert(`Promoted ${checks.length} students.`); closeModal('promotionModal');
        }

        window.showTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('tab-active', 'bg-slate-100'));
            document.getElementById(id).classList.add('active'); document.querySelector(`[data-tab="${id}"]`).classList.add('tab-active');
            if(id === 'reports') document.getElementById('reportMonth').value = new Date().toISOString().slice(0, 7);
            if(id === 'attendance') { document.getElementById('attDate').valueAsDate = new Date(); fetchTodaysLogs(); }
        };
        document.querySelectorAll('.tab-button').forEach(btn => btn.addEventListener('click', () => showTab(btn.dataset.tab)));
        document.getElementById('studentSearch').addEventListener('keyup', e => renderStudents());
        function populateDropdowns() {
            const f = document.getElementById('attFaculty'); const s = document.getElementById('attSubject'); f.innerHTML = '<option value="">Select Faculty</option>'; s.innerHTML = '<option value="">Select Subject</option>';
            facultyData.forEach(d => f.innerHTML += `<option value="${d.name}">${d.name}</option>`); subjectsData.forEach(d => s.innerHTML += `<option value="${d.name}">${d.name}</option>`);
        }
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden'); window.closeModal = (id) => document.getElementById(id).classList.add('hidden'); window.deleteItem = async (coll, id) => { if(confirm("Are you sure?")) await deleteDoc(doc(db, `artifacts/${appId}/public/data/${coll}/${id}`)); };
        
        document.getElementById('generateReportBtn').addEventListener('click', async () => {
            const m = document.getElementById('reportMonth').value; if(!m) return;
            const snap = await getDocs(query(collection(db, `artifacts/${appId}/public/data/dailyAttendance`), where("semester", "==", currentSemester)));
            const logs = []; snap.forEach(d => { if(d.data().date.startsWith(m)) logs.push(d.data()); });
            const report = studentsData.map(s => { let total = 0, absent = 0; logs.forEach(l => { total++; if(l.absentRollNos.includes(s.rollNo)) absent++; }); const attended = total - absent; const pct = total ? Math.round((attended/total)*100) : 0; return { ...s, total, attended, pct }; });
            const body = document.getElementById('monthlyReportBody'); body.innerHTML = '';
            report.forEach(r => { body.innerHTML += `<tr><td class="px-4 py-2 font-mono">${r.rollNo}</td><td class="px-4 py-2">${r.name}</td><td class="px-4 py-2 text-center">${r.total}</td><td class="px-4 py-2 text-center">${r.attended}</td><td class="px-4 py-2 text-right font-bold ${r.pct < 75 ? 'text-red-500':'text-green-600'}">${r.pct}%</td></tr>`; });
            document.getElementById('reportResults').classList.remove('hidden');
        });
        async function fetchTodaysLogs() {
            const d = document.getElementById('attDate').value; const list = document.getElementById('todaysLogsList'); list.innerHTML = '<p class="p-4 text-center text-slate-400">Loading...</p>';
            const snap = await getDocs(query(collection(db, `artifacts/${appId}/public/data/dailyAttendance`), where("semester", "==", currentSemester), where("date", "==", d)));
            list.innerHTML = ''; if(snap.empty) { list.innerHTML = '<p class="p-4 text-center text-slate-400 text-sm">No logs for this date.</p>'; return; }
            snap.forEach(doc => { const data = doc.data(); list.innerHTML += `<div class="p-3 flex justify-between items-center hover:bg-slate-50"><div><span class="font-bold text-indigo-600 text-xs uppercase">Period ${data.periodNo}</span><p class="text-sm font-medium text-slate-700">${data.subjectName}</p><p class="text-xs text-slate-500">${data.facultyName}</p></div><div class="text-right"><span class="text-xs font-bold text-red-500 block">${data.absentRollNos.length} Absent</span><button onclick="deleteItem('dailyAttendance','${doc.id}')" class="text-[10px] text-slate-400 underline">Delete</button></div></div>`; });
        }
        document.getElementById('loginForm').addEventListener('submit', async e => {
            e.preventDefault(); try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); } catch(err) { alert("Login Failed: " + err.message); }
        });
        document.getElementById('btnRegister').addEventListener('click', async () => {
            const e = document.getElementById('email').value; const p = document.getElementById('password').value; if(!e || !p) return alert("Enter email & password");
            try { await createUserWithEmailAndPassword(auth, e, p); } catch(err) { alert("Error: " + err.message); }
        });
        document.getElementById('logoutButton').onclick = () => signOut(auth);
    </script>
</body>

</html>
